<!DOCTYPE html>
<html> 
    <head>
        <title>4-3-1 明确区分出一个依赖关系具体依赖的哪个对象的哪个字段</title>
        <meta charset="utf-8">
    </head>
    <body>
        <div id="app1"></div>
        <script type="module">
            // 明确区分出一个依赖关系具体依赖的哪个对象的哪个字段
            (() => {

                // 用一个全局变量存储当前激活的 effect 函数
                let activeEffect = null;

                // 存储副作用函数的桶
                const bucket = new WeakMap();
                const data = {text: 'hello world'};


                // 对原始数据的代理
                const obj = new Proxy(data, {
                    // 拦截读取操作
                    get(target, key) {
                        console.log('get', target, key);

                        // 没有 activeEffect，直接返回
                        if (!activeEffect) {
                            return target[key];
                        }

                        // 根据 target 从桶中取得 depsMap，它是一个 Map 类型：key -> effects
                        let depsMap = bucket.get(target);
                        // 如果不存在 depsMap，则创建一个新的 Map 并与 target 关联
                        if (!depsMap) {
                            bucket.set(target, (depsMap = new Map()));
                        }

                        // 再根据 key 从 depsMap 中取得 deps，它是一个 Set 类型
                        // 里面存储所有与当前 key 关联的副作用函数
                        let deps = depsMap.get(key);
                        // 如果不存在 deps，则创建一个新的 Set 并与 key 关联
                        if (!deps) {
                            depsMap.set(key, (deps = new Set()));
                        }

                        // 最后将当前激活的副作用函数添加到依赖集合中
                        deps.add(activeEffect);

                        // 返回属性值
                        return target[key];
                    },
                    // 拦截设置操作
                    set(target, key, value) {
                        console.log('set', target, key, value);
                        // 设置属性值
                        target[key] = value;

                        // 根据 target 从桶中取得 depsMap，它存储着 key -> effects
                        const depsMap = bucket.get(target);
                        if (!depsMap) return true;
                        // 根据 key 取得所有副作用函数
                        const effects = depsMap.get(key);
                        console.log('effects', effects);
                        // 执行副作用函数
                        if (effects) {
                            effects.forEach(fn => fn());
                        }
                        return true;
                    }
                })

                // 用于注册副作用函数
                function effect(fn) {
                    // 当调用 effect 注册副作用函数时，将副作用函数 fn 赋值给 activeEffect
                    activeEffect = fn;
                    // 执行副作用函数
                    fn();
                }

                // 执行副作用函数
                effect(
                    // 一个匿名的副作用函数
                    () => {
                        console.log('副作用函数执行了');
                        document.body.innerHTML = obj.text;
                    }
                );

                setTimeout(() => {
                    // 修改响应式数据
                    console.log('修改响应式数据');
                    obj.text = 'hello vue3';
                    console.log('修改没有依赖关系的数据');
                    // 副作用函数中并没有读取 notExist 属性的值，所以修改它不会触发副作用函数重新执行
                    obj.notExist = 'hello vue3';
                }, 1000);
            })();
        </script>
    </body>
</html>