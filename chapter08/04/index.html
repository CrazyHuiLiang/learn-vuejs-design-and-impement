<!DOCTYPE html>
<html> 
    <head>
        <title>8-4. class 的处理</title>
        <meta charset="utf-8">
        <style>
            #foo {
                color: red;
            }
            .bar {
                border-color: red;
            }
            .foo {
                border-style: dashed;
            }
        </style>
    </head>
    <body>
        <div id="app2"></div>
        <script type="module">
            import {effect, ref} from 'vue';
            import {createRenderer} from './renderer.ts';


            // 渲染器除了要执行挂载之外，还需要执行更新动作
            // 通过将渲染器设计为可配置的通用渲染器，即可实现渲染到任意目标平台上
            (() => {
                // 是否应该作为 DOM Properties 设置（还是作为 Attributes 设置）
                function shouldSetAsProps(el, key, value) {
                    // input 元素的 form 属性对应的 DOM Properties 是只读的，需要使用 setAttribute 来设置
                    if (key === 'form' && el.tagName === 'INPUT') {
                        return false;
                    }
                    return key in el;
                }

                // 将多种形式的 class 值转为 DOM Properties 的 className 属性
                function normalizeClass(value) {
                    let res = '';
                    if (typeof value === 'string') {
                        res = value;
                    } else if (Array.isArray(value)) {
                        for (let i = 0; i < value.length; i++) {
                            const normalized = normalizeClass(value[i]);
                            if (normalized) {
                                res += normalized + ' ';
                            }
                        }
                    } else if (Object.prototype.toString.call(value) === '[object Object]') {
                        for (const name in value) {
                            if (value[name]) {
                                res += name + ' ';
                            }
                        }
                    }
                    return res.trim();
                }

                const renderer = createRenderer({
                    // 用于创建元素
                    createElement(tag) {
                        return document.createElement(tag);
                    },
                    // 用于设置元素的文本节点
                    setElementText(el, text) {
                        el.textContent = text;
                    },
                    // 用于在给定的 parent 下添加指定元素
                    insert(el, container, anchor = null) {
                        container.appendChild(el, anchor);
                    },
                    // 属性设置相关的操作
                    patchProps(el, key, prevValue, nextValue) {
                        if (key === 'class') {
                            // 使用 className 性能比通过 setAttribute 和 el.classList 更好
                            el.className = nextValue || '';
                        } else if (shouldSetAsProps(el, key, nextValue)) {
                            const type = typeof el[key];
                            if (type === 'boolean' && nextValue === '') {
                                el[key] = true;
                            } else {
                                el[key] = nextValue;
                            }
                        } else {
                            el.setAttribute(key, nextValue);
                        }
                    }
                });

                const vnode = {
                    type: 'div',
                    props: {
                        id: 'foo',
                        class: normalizeClass([
                            'bar',
                            { foo: true },
                            { baz: false }
                        ]),
                    },
                    children: [
                        {type: 'button', children: 'disabled', props: { disabled: '' }},
                        {type: 'button', children: 'enabled', props: { disabled: false }},
                        {type: 'button', children: 'disabled', props: { disabled: true }},
                        {type: 'input',  props: { form: 'form1', placeholder: 'input1' }},
                    ],
                };
                renderer.render(vnode, document.getElementById('app2'));
            })();
        </script>
    </body>
</html>